---
layout: blogpost
title:  "Integration of the OpenRISC Linux Port into OpTiMSoC"
date:   2017-09-04
categories: general
author: ppenna
---

Linux has was ported to OpTiMSoC during the 2017's Google Sumer of Code.

Since the Kernel source tree is not yet integrated into OpTiMSoC Project, this blog post aims at providing enough information to someone on how to setup Linux on OpTimSoC.

## Part 1: Setup OpTiMSoC

Simply follow the upstream online instructions at: https://www.optimsoc.org/docs/master/user_guide/installation.html

Moreover, be sure to set the OPTIMSOC environment variable to point to the
installation location of OpTiMSoC. For example:

export OPTIMSOC=/opt/optimsoc/2016.1-git086cd8af3484/

## Part 2: Get Development Tools

```
mkdir -p $HOME/toolchain

cd $HOME/toolchain

wget  https://github.com/openrisc/or1k-gcc/releases/download/or1k-5.4.0-20170218/or1k-elf-5.4.0-20170218.tar.bz2

tar -xjvf or1k-elf-5.4.0-20170218.tar.bz2

wget https://github.com/openrisc/or1k-gcc/releases/download/or1k-5.4.0-20170218/or1k-linux-musl-5.4.0-20170218.tar.bz2

tar -xjvf or1k-linux-musl-5.4.0-20170218.tar.bz2

wget https://github.com/openrisc/or1k-gcc/releases/download/or1k-5.4.0-20170218/or1k-linux-5.4.0-20170218.tar.bz2

tar -xjvf or1k-linux-5.4.0-20170218.tar.bz2
```

## Part 3: Build Unit Tests

```
export LIBS=$OPTIMSOC/soc/sw/lib/baremetal/libbaremetal.a

git clone https://github.com/optimsoc/linux-apps $HOME/linux-apps

cd $HOME/linux-apps/

export CC=$HOME/toolchain/or1k-linux-musl/bin/or1k-linux-musl-gcc


$CC hello-linux/hello.c -o hello-linux/hello

export CC=$HOME/toolchain/or1k-elf/bin/or1k-elf-gcc
export CFLAGS=”-I $OPTIMSOC/soc/sw/include/baremetal/”

$CC $CFLAGS hello-baremetal/hello.c -o hello-baremetal/hello $LIBS    
```

## Part 4: Build Linux

```
export PATH=$PATH:$HOME/toolchain/or1k-linux/bin/
export ARCH=openrisc
export CROSS_COMPILE=or1k-linux-

git clone https://github.com/optimsoc/linux.git $HOME/linux

cd $HOME/linux

mkdir -p $HOME/linux/arch/openrisc/initramfs/
    cp $HOME/linux-apps/hello-linux/hello $HOME/linux/arch/openrisc/initramfs/

make optimsoc_defconfig
make modules
make
```

## Part 5: Run on Verilator

```
$OPTIMSOC/examples/sim/system_2x2_cccc/system_2x2_cccc_sim_dualcore_debug

opensocdebugd tcp

osd-cli
reset -halt
mem loadelf $HOME/linux/vmlinux 2
mem loadelf $HOME/hello-baremetal/hello 6
terminal 5
start
```
