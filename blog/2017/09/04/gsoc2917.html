<!DOCTYPE html>
<html lang="en">
<head>
  <title>GSoC 2017 Project: Integration of the OpenRISC Linux Port into OpTiMSoC</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- external CSS -->
  <link href="//netdna.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">

  <!-- our own CSS (must be include after bootstrap.css!) -->
  <link rel="stylesheet" href="/css/optimsoc.css"/>

  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
    <script src="/js/html5shiv.js"></script>
    <script src="/js/respond.min.js"></script>
  <![endif]-->

  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Google Web Fonts -->
  <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,400italic,600,700,900" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro:400,500,600,700" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Fredericka+the+Great" rel="stylesheet" type="text/css">
</head>
<body  data-offset='50' data-spy="scroll" data-target="">
  <!-- top navigation bar -->
  <nav class="navbar navbar-fixed-top optimsoc-nav" role="navigation">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/index.html" alt="OpTiMSoC"><span class="wordmark">OpTiMSoC</span></a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/download.html">Download</a></li>
          <li><a href="/docs/index.html">Documentation</a></li>
          <li><a href="/getinvolved.html">Get involved</a></li>
          <li><a href="/about.html">About</a></li>
          <li><a href="/blog">Blog</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container" id="maincontent">
  

  
<h1>GSoC 2017 Project: Integration of the OpenRISC Linux Port into OpTiMSoC</h1>

<div class="container">
  <div class="row">
    <div class="col-md-10">
      <p>Linux was ported to OpTiMSoC during the 2017’s Google Sumer of Code. This blog
post details the work that was accomplished during the project; and as well the work
that was left to be tackled.</p>

<p>To port Linux to OpTiMSoC, a new manycore configuration with a Host Tile was designed and
implemented. The Host Tile runs OpenRISC Linux and communicates with
applications running on Computing Tiles via message-passing through the
Network-on-Chip (NoC). Overall, the communication infrastructure is exported to
user-level through standard UNIX file system operations, thereby enabling
user-level applications running on the Host Tile to rely on a high-level
communication abstractions.</p>

<h2 id="i-design">I. Design</h2>

<p>Figure 1 presents and the design overview of this project. A manycore
configuration featuring six tiles is depicted, one host tile and five compute
tiles. The host tile has a UART device attached to it and runs the OpenRISC
port of Linux; whereas compute tiles runs user-level applications bare metal.
Processes running on the Host Tile and user-level applications running on the
Compute Tile communicate with one another via message-passing.</p>

<p><img src="https://lh6.googleusercontent.com/RNhSim8cI60Tlxoow31vsldGeG2oHcLEsdjJHKaWlBXlTWe6_WuH5Facrp2VGM3f4-DuX-BDt_V6569dTISxWqoTt8Q3JdXxr0r_XNMRo-S8y82hByMaatmNzrx_ERKgbBQktcHf" alt="" /></p>

<p><strong>Figure 1:</strong> Overview of the target manycore configuration.</p>

<p>The OpenRisc Linux kernel running on the Host Tile features a Network-on-Chip
(NoC) driver on which processes rely to send/receive messages. Operations on
this driver are exported to userland through the standard UNIX system calls for
manipulating files. Code Snippet 1 illustrates how a process running on the
Host Tile send messages based on this abstraction. As a side remark, note that
the user-level application should explicitly build the message header. In
future implementation, the idea is to have a user-level library that does this
job for the application. On the other hand, in Compute Tiles, user-level
applications rely on a baremetal message-passing library to carry out a
communication with other tiles.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>int main(int argc, char **argv)
{
    int fd;
    const char *devname = "/dev/noc";

    /* Open NoC device. */
    fd = open(devname, O_WRONLY);
    
    /* Write some data. */
    while (int i = 0; i &lt; 100; i++) {
        unsigned dest = 0x8000000;
        unsigned data = 0x0000dead;
        unsigned msg = dest | data;
        write(fd, &amp;msg, sizeof(unsigned));
    }
   
    /* Close NoC device. */
    close(fd);

    return (EXIT_SUCCESS);
}
</code></pre></div></div>

<h2 id="ii-noc-driver-implementation">II. NoC Driver Implementation</h2>

<p>To enable inter-tile communication, a NoC device driver for Linux was written.
This device driver was implemented as a dynamically loadable module and it exports operations on the NoC to userland through regular file system calls. The main internal  routines of the implemented driver are discussed next.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/*
 * Opens a NoC endpoint. The device minor number is used to
 * identify the target endpoint to open. Access to an endpoint
 * is exclusive, ie. only one process may use a given endpoint
 * at a time.
 */
int optimsoc_open(struct inode *, struct file *);

/*
 * Releases a NoC endpoint. The device minor number is is used
 * to identify the target  endpoint to release. Underlying
 * resources associated with the endpoint are released.
 */
int optimsoc_release(struct inode, struct file *);

/*
 * Sends messages over an endpoint. The device minor number
 * is used to identify the target endpoint to use on the
 * communication. Sending messages does not block the
 * calling process. The size of messages should be aligned
 * on word size (32 bits). Message headers should be built
 * on user-space.
 */
ssize_t optimsoc_write(struct file *, const char *, size_t, off_t);

/*
 * Receives messages over an endpoint. The device minor
 * number is used to identify the target endpoint to use on
 * the communication. Sending messages blocks the calling
 * process. Flits of a message are buffered in kernel land.
 */
ssize_t optimsoc_read(struct file *, const char *, size_t, off_t);
</code></pre></div></div>

<h2 id="iii-building-the-project">III. Building the Project</h2>

<p>Since the Linux source tree is not yet integrated into OpTiMSoC Project, you should follow the next steps to get it running on OpTiMSoC.</p>

<h3 id="part-1-setup-optimsoc">Part 1: Setup OpTiMSoC</h3>

<p>Follow the upstream online instructions at: https://www.optimsoc.org/docs/master/user_guide/installation.html</p>

<p><strong>In the end, set the <code class="language-plaintext highlighter-rouge">OPTIMSOC</code> environment variable to point to the
installation location of OpTiMSoC.</strong></p>

<h3 id="part-2-get-development-tools">Part 2: Get Development Tools</h3>

<p>To build Linux, you will need a slightly diferent toolchain than the one used to build OpTiMSoC.</p>

<ul>
  <li>Musl Toolchain</li>
  <li>Newlib Baremetal Toolchain</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir -p $HOME/toolchain

cd $HOME/toolchain

wget  https://github.com/openrisc/or1k-gcc/releases/download/or1k-5.4.0-20170218/or1k-elf-5.4.0-20170218.tar.bz2

tar -xjvf or1k-elf-5.4.0-20170218.tar.bz2

wget https://github.com/openrisc/or1k-gcc/releases/download/or1k-5.4.0-20170218/or1k-linux-musl-5.4.0-20170218.tar.bz2

tar -xjvf or1k-linux-musl-5.4.0-20170218.tar.bz2

wget https://github.com/openrisc/or1k-gcc/releases/download/or1k-5.4.0-20170218/or1k-linux-5.4.0-20170218.tar.bz2

tar -xjvf or1k-linux-5.4.0-20170218.tar.bz2
</code></pre></div></div>

<h3 id="part-3-build-unit-tests-optional">Part 3: Build Unit Tests (Optional)</h3>

<p>You can test your Linux build in OpTiMSoC with a simple distributed application:</p>

<ul>
  <li><strong>hello-linux:</strong> runs on a host tile on top of Linux and simply sends raw messages to a remote compute tile.</li>
  <li><strong>hello-baremetal</strong>: runs on a compute tile on baremental, and simply read messages that arrive at the local NoC adapater and print them on the screen.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export LIBS=$OPTIMSOC/soc/sw/lib/baremetal/libbaremetal.a

git clone https://github.com/optimsoc/linux-apps $HOME/linux-apps

cd $HOME/linux-apps/

export CC=$HOME/toolchain/or1k-linux-musl/bin/or1k-linux-musl-gcc


$CC hello-linux/hello.c -o hello-linux/hello

export CC=$HOME/toolchain/or1k-elf/bin/or1k-elf-gcc
export CFLAGS=”-I $OPTIMSOC/soc/sw/include/baremetal/”

$CC $CFLAGS hello-baremetal/hello.c -o hello-baremetal/hello $LIBS    
</code></pre></div></div>

<h3 id="part-4-build-linux">Part 4: Build Linux</h3>

<p>Setup toolchain.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export PATH=$PATH:$HOME/toolchain/or1k-linux/bin/
export ARCH=openrisc
export CROSS_COMPILE=or1k-linux-
</code></pre></div></div>

<p>(Optional) If you have built unit tests from Step 3, you should copy <code class="language-plaintext highlighter-rouge">hello-linux</code> to the the initramfs directory.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir -p $HOME/linux/arch/openrisc/initramfs/
    cp $HOME/linux-apps/hello-linux/hello $HOME/linux/arch/openrisc/initramfs/
</code></pre></div></div>

<p>Clone and build Linux. Note that this is done in three steps: (i) build system configuration; (ii) build dynamic modules; and (iii) build the kernel.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/optimsoc/linux.git $HOME/linux

cd $HOME/linux

make optimsoc_defconfig
make modules
make
</code></pre></div></div>

<h2 id="iii-conclusions">III. Conclusions</h2>

<p>During this GSoC project I wrote a Linux NoC driver for OpTiMSoC-based platforms. This driver was implemented as a dynamically loadable module and used standard file system kernel calls to export the message passing of the underlying platform to user space. 
Concerning the current  implementation, the following work remains open:</p>

<ul>
  <li><strong>[Enhancement] Enable Endpoints to Be Multiplexed.</strong> In the current implementation, only process at a time may use a given endpoint. A nice feature to have would be to enable multiple processes to concurrently use an endpoint.</li>
  <li><strong>[Bug Fix] Properly Install the Interrupt Handler.</strong> In the current implementation, when the interrupt handler is registered, the boot sequence halts when running on Verilator/FPGA. Interrupt-firing behavior should be investigated and the interrupt handler setup should be fixed accordingly.</li>
</ul>

    </div>
    <div class="col-md-2 optimsoc-blog-meta">
      <p>by Pedro H. Penna <br/>on 04 September 2017</p>
      <img class="img-rounded" src="/img/people/ppenna.jpg"/>
      <hr/>
      <b>Share this post at:</b>
      <ul class="share-buttons">
	<li><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.optimsoc.org&t=" title="Share on Facebook" target="_blank" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(document.URL) + '&t=' + encodeURIComponent(document.URL)); return false;"><img src="/img/flat_web_icon_set/color/Facebook.png"></a></li>
	<li><a href="https://twitter.com/intent/tweet?source=http%3A%2F%2Fwww.optimsoc.org&text=:%20http%3A%2F%2Fwww.optimsoc.org" target="_blank" title="Tweet" onclick="window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(document.title) + ':%20'  + encodeURIComponent(document.URL)); return false;"><img src="/img/flat_web_icon_set/color/Twitter.png"></a></li>
	<li><a href="https://plus.google.com/share?url=http%3A%2F%2Fwww.optimsoc.org" target="_blank" title="Share on Google+" onclick="window.open('https://plus.google.com/share?url=' + encodeURIComponent(document.URL)); return false;"><img src="/img/flat_web_icon_set/color/Google+.png"></a></li>
	<li><a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Fwww.optimsoc.org&title=&summary=&source=http%3A%2F%2Fwww.optimsoc.org" target="_blank" title="Share on LinkedIn" onclick="window.open('http://www.linkedin.com/shareArticle?mini=true&url=' + encodeURIComponent(document.URL) + '&title=' +  encodeURIComponent(document.title)); return false;"><img src="/img/flat_web_icon_set/color/LinkedIn.png"></a></li>
      </ul>
    </div>
  </div>
</div>

</div>


  <!-- footer -->
  <hr>
  <footer class="optimsoc-footer">
    <p>OpTiMSoC &copy; 2012-2021 OpTiMSoC Maintainers &middot; Imprint</p>
  </footer>

  <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
</body>
</html>
